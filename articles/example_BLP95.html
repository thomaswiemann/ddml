<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Example based on Berry, Levinson, &amp; Pakes (1995) • ddml</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Example based on Berry, Levinson, &amp; Pakes (1995)">
<!-- Copyright (c) 2000-2023 etracker GmbH. All rights reserved. --><!-- This material may not be reproduced, displayed, modified or distributed --><!-- without the express prior written permission of the copyright holder. --><!-- etracker tracklet 5.0 --><script type="text/javascript">
// var et_pagename = "";
// var et_areas = "";
// var et_tval = 0;
// var et_tsale = 0;
// var et_tonr = "";
// var et_basket = "";
</script><script id="_etLoader" type="text/javascript" charset="UTF-8" data-block-cookies="true" data-secure-code="6ggnmg" src="//code.etracker.com/code/e.js" async></script><!-- etracker tracklet 5.0 end --><!-- math rendering issues  https://github.com/r-lib/pkgdown/issues/2704 --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ddml</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/ddml.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/stacking.html">Computational Benefits of Short-Stacking</a></li>
    <li><a class="dropdown-item" href="../articles/new_ml_wrapper.html">Constructing a User-Provided Base Learner</a></li>
    <li><a class="dropdown-item" href="../articles/sparse.html">Estimation with Sparse Matrices</a></li>
    <li><a class="dropdown-item" href="../articles/did.html">Diff-in-Diff with Double/Debiased Machine Learning</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/thomaswiemann/ddml/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Example based on Berry, Levinson, &amp; Pakes (1995)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/thomaswiemann/ddml/blob/master/vignettes/articles/example_BLP95.Rmd" class="external-link"><code>vignettes/articles/example_BLP95.Rmd</code></a></small>
      <div class="d-none name"><code>example_BLP95.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This article revisits the empirical example of Chernozhukov, Hansen,
and Spindler (2015) (CHS2015, hereafter), which extends the instruments
of Berry, Levinsohn, and Pakes (1995) (BLP1995, hereafter) and applies
an instrument selection procedure based on the lasso. We consider the
same instrument extension and apply double/debiased machine learning
with short-stacking that combines conventional linear estimators with
computational alternatives including lasso-based approaches, random
forests, and gradient boosting.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/thomaswiemann/ddml" class="external-link">ddml</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">AER</span><span class="op">)</span> <span class="co"># for iv regression</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">713954</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-construction">Data Construction<a class="anchor" aria-label="anchor" href="#data-construction"></a>
</h2>
<p>We consider the automobile market data from Berry, Levinsohn, Pakes
(1995) as retrieved from the reproduction exercise in Chernozhukov,
Hansen, and Spindler (2015). <a href="https://www.aeaweb.org/articles?id=10.1257/aer.p20151022" class="external-link">link</a></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">BLP95</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/BLP95.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">share</span><span class="op">)</span> <span class="op">-</span>  <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">outshr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">price</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">BLP95</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hpwt"</span>, <span class="st">"air"</span>, <span class="st">"mpd"</span>, <span class="st">"space"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"share"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">D</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"price"</span></span></code></pre></div>
<p>The below snippet constructs the BLP1995 instruments, which are sums
of product characteristics (excluding price and other potentially
endogenous variables) of other products offered by the firm as well as
over competing firms. The exact instrument specification here follows
the approach of CHS2015.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncol_X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">sum_other</span> <span class="op">&lt;-</span> <span class="va">sum_rival</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">nobs</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nobs</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">other_ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">firmid</span> <span class="op">==</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">firmid</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>    <span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">cdid</span> <span class="op">==</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">cdid</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">id</span> <span class="op">!=</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">rival_ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">firmid</span> <span class="op">!=</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">firmid</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>    <span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">cdid</span> <span class="op">==</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">cdid</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">sum_other</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">other_ind</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">sum_rival</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">rival_ind</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="co">#FOR</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">sum_other</span>, <span class="va">sum_rival</span><span class="op">)</span>; <span class="va">ncol_Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Z</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of baseline controls: "</span>, <span class="va">ncol_X</span>, <span class="st">"\n"</span>,</span>
<span>    <span class="st">"Number of baseline instruments: "</span>, <span class="va">ncol_Z</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of baseline controls:  5 </span></span>
<span><span class="co">#&gt;  Number of baseline instruments:  10</span></span></code></pre></div>
<p>In addition, we may be interested in extending the list of
instruments. The below constructs the additional instruments considered
in CHS2015.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tu</span> <span class="op">=</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">trend</span><span class="op">/</span><span class="fl">19</span>;</span>
<span><span class="va">mpdu</span> <span class="op">=</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">mpd</span><span class="op">/</span><span class="fl">7</span>;</span>
<span><span class="va">spaceu</span> <span class="op">=</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">space</span><span class="op">/</span><span class="fl">2</span>;</span>
<span><span class="va">XL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">BLP95</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hpwt"</span>, <span class="st">"air"</span><span class="op">)</span><span class="op">]</span>, <span class="va">mpdu</span>, <span class="va">spaceu</span>, <span class="va">tu</span>,</span>
<span>                      <span class="va">BLP95</span><span class="op">$</span><span class="va">hpwt</span><span class="op">^</span><span class="fl">2</span>, <span class="va">BLP95</span><span class="op">$</span><span class="va">hpwt</span><span class="op">^</span><span class="fl">3</span>, <span class="va">mpdu</span><span class="op">^</span><span class="fl">2</span>, <span class="va">mpdu</span><span class="op">^</span><span class="fl">3</span>,</span>
<span>                      <span class="va">spaceu</span><span class="op">^</span><span class="fl">2</span>, <span class="va">spaceu</span><span class="op">^</span><span class="fl">3</span>, <span class="va">tu</span><span class="op">^</span><span class="fl">2</span>, <span class="va">tu</span><span class="op">^</span><span class="fl">3</span>, <span class="va">BLP95</span><span class="op">$</span><span class="va">hpwt</span> <span class="op">*</span></span>
<span>                        <span class="va">BLP95</span><span class="op">$</span><span class="va">air</span>,  <span class="va">mpdu</span> <span class="op">*</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">air</span>, <span class="va">spaceu</span> <span class="op">*</span></span>
<span>                        <span class="va">BLP95</span><span class="op">$</span><span class="va">air</span>, <span class="va">tu</span> <span class="op">*</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">air</span>, <span class="va">BLP95</span><span class="op">$</span><span class="va">hpwt</span> <span class="op">*</span></span>
<span>                        <span class="va">mpdu</span>, <span class="va">BLP95</span><span class="op">$</span><span class="va">hpwt</span> <span class="op">*</span> <span class="va">spaceu</span>, <span class="va">BLP95</span><span class="op">$</span><span class="va">hpwt</span> <span class="op">*</span> <span class="va">tu</span>,</span>
<span>                      <span class="va">mpdu</span> <span class="op">*</span> <span class="va">spaceu</span>,  <span class="va">mpdu</span> <span class="op">*</span> <span class="va">tu</span>, <span class="va">spaceu</span> <span class="op">*</span> <span class="va">tu</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ncol_XL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">XL</span><span class="op">)</span></span>
<span><span class="va">sum_otherL</span> <span class="op">&lt;-</span> <span class="va">sum_rivalL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">nobs</span>, <span class="fl">24</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nobs</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">other_ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">firmid</span> <span class="op">==</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">firmid</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>    <span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">cdid</span> <span class="op">==</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">cdid</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">id</span> <span class="op">!=</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">rival_ind</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">firmid</span> <span class="op">!=</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">firmid</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>    <span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">cdid</span> <span class="op">==</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">cdid</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">sum_otherL</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">XL</span><span class="op">[</span><span class="va">other_ind</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">sum_rivalL</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">XL</span><span class="op">[</span><span class="va">rival_ind</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="co">#FOR</span></span>
<span><span class="va">ZL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">sum_otherL</span>,<span class="va">sum_rivalL</span><span class="op">)</span>; <span class="va">ncol_ZL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">ZL</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of extended controls: "</span>, <span class="va">ncol_XL</span>, <span class="st">"\n"</span>,</span>
<span>    <span class="st">"Number of extended instruments: "</span>, <span class="va">ncol_ZL</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of extended controls:  24 </span></span>
<span><span class="co">#&gt;  Number of extended instruments:  48</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="baseline-estimates">Baseline Estimates<a class="anchor" aria-label="anchor" href="#baseline-estimates"></a>
</h2>
<p>We begin by computing the OLS and TSLS estimates using the baseline
controls and instrumental variables. Note that the TSLS estimates differ
from those in CHS2015. This is due to a slight instrument-construction
error in the original code of the CHS2015.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ols_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">+</span> <span class="va">X</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ols_fit</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Estimate Std. Error    t value   Pr(&gt;|t|) </span></span>
<span><span class="co">#&gt;    -0.0886     0.0040   -22.0145     0.0000</span></span>
<span></span>
<span><span class="va">tsls_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AER/man/ivreg.html" class="external-link">ivreg</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">+</span> <span class="va">X</span> <span class="op">|</span> <span class="va">X</span> <span class="op">+</span> <span class="va">Z</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">tsls_fit</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Estimate Std. Error    t value   Pr(&gt;|t|) </span></span>
<span><span class="co">#&gt;    -0.1357     0.0108   -12.5993     0.0000</span></span></code></pre></div>
<p>Similarly, we compute estimates using the expanded set of controls
and instruments.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ols_L_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">+</span> <span class="va">XL</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ols_L_fit</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Estimate Std. Error    t value   Pr(&gt;|t|) </span></span>
<span><span class="co">#&gt;    -0.0991     0.0044   -22.4630     0.0000</span></span>
<span></span>
<span><span class="va">tsls_L_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AER/man/ivreg.html" class="external-link">ivreg</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">D</span> <span class="op">+</span> <span class="va">XL</span> <span class="op">|</span> <span class="va">XL</span> <span class="op">+</span> <span class="va">ZL</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">tsls_L_fit</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span>, <span class="op">]</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Estimate Std. Error    t value   Pr(&gt;|t|) </span></span>
<span><span class="co">#&gt;    -0.1258     0.0070   -17.8691     0.0000</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="estimating-the-flexible-partially-linear-iv-model-with-cv-lasso">Estimating the Flexible Partially Linear IV Model with CV-Lasso<a class="anchor" aria-label="anchor" href="#estimating-the-flexible-partially-linear-iv-model-with-cv-lasso"></a>
</h2>
<p>Given the large set of controls and instruments in the expanded set
relative to the moderate sample size, it is reasonable to consider
regularized estimators. A frequent choice with many variables are
lasso-based estimators. Below, we combine double/debiased machine
learning with lasso selection of instruments and controls. (See
<code><a href="../reference/mdl_glmnet.html">?mdl_glmnet</a></code> and <code><a href="../reference/ddml_fpliv.html">?ddml_fpliv</a></code> for details.)</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base learner</span></span>
<span><span class="va">learner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>what <span class="op">=</span> <span class="va">mdl_glmnet</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate the ddml estimator using a single base learner</span></span>
<span><span class="va">lasso_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ddml_fpliv.html">ddml_fpliv</a></span><span class="op">(</span><span class="va">y</span>, D <span class="op">=</span> <span class="va">D</span>,</span>
<span>                        Z <span class="op">=</span> <span class="va">ZL</span>, X <span class="op">=</span> <span class="va">XL</span>,</span>
<span>                        learners <span class="op">=</span> <span class="va">learner</span>,</span>
<span>                        sample_folds <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                        silent <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">lasso_fit</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, , <span class="fl">1</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Estimate Std. Error    t value   Pr(&gt;|t|) </span></span>
<span><span class="co">#&gt;    -0.1473     0.0090   -16.3142     0.0000</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="estimating-the-flexible-partially-linear-iv-model-with-multiple-learners">Estimating the Flexible Partially Linear IV Model with Multiple
Learners<a class="anchor" aria-label="anchor" href="#estimating-the-flexible-partially-linear-iv-model-with-multiple-learners"></a>
</h2>
<p>A more ambitious approach may consider a variety of computational
models for the estimation of the first and second stage. Here, we
consider a combination of linear models, including unpenalized
regression (see <code><a href="../reference/ols.html">?ols</a></code>), lasso and ridge regression, random
forests (see <code><a href="../reference/mdl_ranger.html">?mdl_ranger</a></code>), and boosted trees (see
<code><a href="../reference/mdl_xgboost.html">?mdl_xgboost</a></code>).</p>
<p>In addition to allowing for different machine learners, we also
consider different sets of instruments and controls: Either the initial
set of instruments as in BLP1995 or the extended set as in CHS2015. For
this purpose, it is convenient to pre-specify sets of indices
corresponding to the initial and extended sets.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Construct column indices for combined control and instrument sets</span></span>
<span><span class="va">X_c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">XL</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X_c</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X_c</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Z_c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Z</span>, <span class="va">ZL</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Z_c</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Z_c</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">set_X</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>; <span class="va">set_XL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X_c</span><span class="op">)</span><span class="op">)</span>, <span class="va">set_X</span><span class="op">)</span></span>
<span><span class="va">set_Z</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Z</span><span class="op">)</span>; <span class="va">set_ZL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Z_c</span><span class="op">)</span><span class="op">)</span>, <span class="va">set_Z</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Base learners</span></span>
<span><span class="va">learners</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">ols</span>, <span class="co"># ols with the baseline set</span></span>
<span>                      assign_X <span class="op">=</span> <span class="va">set_X</span>,</span>
<span>                      assign_Z <span class="op">=</span> <span class="va">set_Z</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">ols</span>, <span class="co"># ols with the extended set</span></span>
<span>                      assign_X <span class="op">=</span> <span class="va">set_XL</span>,</span>
<span>                      assign_Z <span class="op">=</span> <span class="va">set_ZL</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">mdl_glmnet</span>, <span class="co"># lasso with the extended set</span></span>
<span>                      args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                      assign_X <span class="op">=</span> <span class="va">set_XL</span>,</span>
<span>                      assign_Z <span class="op">=</span> <span class="va">set_ZL</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">mdl_glmnet</span>, <span class="co"># ridge with the extended set</span></span>
<span>                      args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                      assign_X <span class="op">=</span> <span class="va">set_XL</span>,</span>
<span>                      assign_Z <span class="op">=</span> <span class="va">set_ZL</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">mdl_ranger</span>, <span class="co"># random forests with the baseline set</span></span>
<span>                      args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>num.trees <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                                  min.node.size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>                      assign_X <span class="op">=</span> <span class="va">set_X</span>,</span>
<span>                      assign_Z <span class="op">=</span> <span class="va">set_Z</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">mdl_xgboost</span>, <span class="co"># boosted trees with the baseline set</span></span>
<span>                      args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nrounds <span class="op">=</span> <span class="fl">300</span><span class="op">)</span>,</span>
<span>                      assign_X <span class="op">=</span> <span class="va">set_X</span>,</span>
<span>                      assign_Z <span class="op">=</span> <span class="va">set_Z</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute short-stacked IV estimate</span></span>
<span><span class="va">stacking_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ddml_fpliv.html">ddml_fpliv</a></span><span class="op">(</span><span class="va">y</span>, D <span class="op">=</span> <span class="va">D</span>,</span>
<span>                           Z <span class="op">=</span> <span class="va">Z_c</span>, X <span class="op">=</span> <span class="va">X_c</span>,</span>
<span>                           learners <span class="op">=</span> <span class="va">learners</span>,</span>
<span>                           ensemble_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nnls1"</span><span class="op">)</span>,</span>
<span>                           shortstack <span class="op">=</span> <span class="cn">T</span>,</span>
<span>                           sample_folds <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                           silent <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">stacking_fit</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, , <span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;      Estimate Std. Error  t value Pr(&gt;|t|)</span></span>
<span><span class="co">#&gt; [1,]  -0.0982     0.0092 -10.7008        0</span></span></code></pre></div>
<p>Interestingly, the coefficient is closer to the OLS estimates than to
the TSLS estimates (with or without lasso)!</p>
<p>To better understand the composition of the final estimator, it is
often useful to inspect the stacking weights. These may readily be
retrieved from the fitted object. Here, we see that the boosted trees
and the random forest learners have been assigned the most weight in the
cross validation informed ensemble procedures. The linear methods – ols,
lasso, and ridge – do not contribute substantially to the final
estimates, suggesting that the user-defined expansions of the controls
and instruments does little to improve bias and precision.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">stacking_fit</span><span class="op">$</span><span class="va">weights</span>, <span class="va">round</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;         y_X D1_X  D1_XZ</span></span>
<span><span class="co">#&gt; [1,] 0.0000 0.00 0.0000</span></span>
<span><span class="co">#&gt; [2,] 0.0000 0.00 0.0000</span></span>
<span><span class="co">#&gt; [3,] 0.0000 0.00 0.0000</span></span>
<span><span class="co">#&gt; [4,] 0.0000 0.00 0.0000</span></span>
<span><span class="co">#&gt; [5,] 0.4394 0.45 0.3804</span></span>
<span><span class="co">#&gt; [6,] 0.5606 0.55 0.6196</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="elasticities">Elasticities<a class="anchor" aria-label="anchor" href="#elasticities"></a>
</h2>
<p>Equipped with the multiple coefficient estimates, we may recalculate
the number of products with inelastic demand as in CHS2015.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">compute_inelastic_demand</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">price_coef</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">price_coef</span> <span class="op">*</span> <span class="op">(</span><span class="va">BLP95</span><span class="op">$</span><span class="va">price</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">BLP95</span><span class="op">$</span><span class="va">share</span><span class="op">)</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="co">#COMPUTE_INELASTIC_DEMAND</span></span></code></pre></div>
<p>BLP1995’s TSLS estimates suggest about 746-896 products with
inelastic demand, nearly half of the number of products implied by
simple OLS estimates.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># OLS implied number of products with inelastic demand</span></span>
<span><span class="fu">compute_inelastic_demand</span><span class="op">(</span><span class="va">ols_fit</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1502</span></span>
<span><span class="fu">compute_inelastic_demand</span><span class="op">(</span><span class="va">ols_L_fit</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1405</span></span>
<span></span>
<span><span class="co"># TSLS implied number of products with inelastic demand</span></span>
<span><span class="fu">compute_inelastic_demand</span><span class="op">(</span><span class="va">tsls_fit</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 746</span></span>
<span><span class="fu">compute_inelastic_demand</span><span class="op">(</span><span class="va">tsls_L_fit</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 896</span></span></code></pre></div>
<p>Double/debiased machine learning estimates using only a single lasso
base learner suggest the smallest number of inelastic products. In stark
contrast, the estimates based on multiple machine learners suggest a
number closer to the intial OLS estimates.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ddml-lasso implied number of products with inelastic demand</span></span>
<span><span class="fu">compute_inelastic_demand</span><span class="op">(</span><span class="va">lasso_fit</span><span class="op">$</span><span class="va">coef</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 596</span></span>
<span></span>
<span><span class="co"># ddml-stacking implied number of products with inelastic demand</span></span>
<span><span class="fu">compute_inelastic_demand</span><span class="op">(</span><span class="va">stacking_fit</span><span class="op">$</span><span class="va">coef</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1417</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="bonus-post-lasso-estimates-without-sample-splitting">Bonus: Post-Lasso Estimates without Sample-Splitting<a class="anchor" aria-label="anchor" href="#bonus-post-lasso-estimates-without-sample-splitting"></a>
</h2>
<p>In addition to <code>ddml</code>, we can also consider estimators
from the <code>hdm</code> package based on rigorous lasso – i.e., with
plug-in penalty parameters and without sample-splitting.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load hdm</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">hdm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute post-lasso IV estimator with the plug-in penalty</span></span>
<span><span class="va">rlassoIV_fit</span> <span class="op">&lt;-</span> <span class="fu">rlassoIV</span><span class="op">(</span>x <span class="op">=</span> <span class="va">XL</span>, d <span class="op">=</span> <span class="va">D</span>, y <span class="op">=</span> <span class="va">y</span>, z <span class="op">=</span> <span class="va">ZL</span>,</span>
<span>                         select.Z <span class="op">=</span> <span class="cn">TRUE</span>, select.X <span class="op">=</span> <span class="cn">FALSE</span>, post <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">rlassoIV_fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Estimates and significance testing of the effect of target variables in the IV regression model"</span></span>
<span><span class="co">#&gt;        coeff.      se. t-value  p-value    </span></span>
<span><span class="co">#&gt; [1,] -0.31558  0.05354  -5.894 3.78e-09 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code></pre></div>
<p>The coefficient is drastically different from previous estimates,
including the double/debaised machine learning estimates that included
lasso-based approaches.</p>
<p>To gain some insight into potential causes for these differences, we
check which instruments and controls were selected by the lasso
procedure. Not surprisingly, lasso with a plug-in penalty selects only
very few instruments and controls.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Zr_</span> <span class="op">&lt;-</span> <span class="va">ZL</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">rlassoIV_fit</span><span class="op">$</span><span class="va">selected</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">48</span><span class="op">]</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">Zr_</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="va">Xr_</span> <span class="op">&lt;-</span> <span class="va">XL</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">rlassoIV_fit</span><span class="op">$</span><span class="va">selected</span><span class="op">[</span><span class="fl">49</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">rlassoIV_fit</span><span class="op">$</span><span class="va">selected</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">Xr_</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 6</span></span></code></pre></div>
<p>From the stacking weights above, we know that the double/debaised
machine learning estimator assigns most weight to boosted trees. In
contrast to lasso-based estimates, boosted trees adaptively create
interactions from their input variables, allowing for rich
non-linearities in the final predictions. It thus makes sense to check
whether the stark differences between the rlasso-based IV estimates
above and the stacking estimates is primarily due to potential
non-linearities as opposed to the specific instrument and control
variables that were selected. The below code snippet re-estimates the
stacking learner with the pre-selected set of controls and
instruments.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base learner</span></span>
<span><span class="va">learner</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">ols</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">mdl_xgboost</span>,</span>
<span>                     args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>nrounds <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute short-stacked IV estimate</span></span>
<span><span class="va">stacking_r_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ddml_fpliv.html">ddml_fpliv</a></span><span class="op">(</span><span class="va">y</span>, D <span class="op">=</span> <span class="va">D</span>,</span>
<span>                        Z <span class="op">=</span> <span class="va">Zr_</span>, X <span class="op">=</span> <span class="va">Xr_</span>,</span>
<span>                        learners <span class="op">=</span> <span class="va">learner</span>,</span>
<span>                        ensemble_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nnls1"</span><span class="op">)</span>,</span>
<span>                        shortstack <span class="op">=</span> <span class="cn">T</span>,</span>
<span>                        sample_folds <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                        silent <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">stacking_r_fit</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span>, , <span class="fl">1</span><span class="op">]</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Estimate Std. Error    t value   Pr(&gt;|t|) </span></span>
<span><span class="co">#&gt;    -0.1044     0.0128    -8.1682     0.0000</span></span></code></pre></div>
<p>The similarity of the coefficient estimates to the initial stacking
estimates suggest seems that adaptively created interactions are indeed
the key driver between the coefficient differences. This is further
confirmed by the stacking weights, which again place substantial weight
on the boosted trees.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">stacking_r_fit</span><span class="op">$</span><span class="va">weights</span>, <span class="va">round</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">#&gt;       y_X   D1_X  D1_XZ</span></span>
<span><span class="co">#&gt; [1,] 0.08 0.1287 0.0439</span></span>
<span><span class="co">#&gt; [2,] 0.92 0.8713 0.9561</span></span></code></pre></div>
<p>The example thus highlights the importance of considering multiple
machine learners for robustness and illustrates the usefulness of
double/debiased machine learning with stacking as a practical
solution.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Berry S, Levinshon J, Pakes A (1995). “Automobile Prices in Market
Equilibrium.” Econometrica, 63(4), 841-890.</p>
<p>Chernozhukov V, Hansen C, Spindler M (2015). “Post-selection and
post-regularization inference in linear models with many controls and
instruments.” American Economic Review, 105(5), 486-490.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Achim Ahrens, Christian B Hansen, Mark E Schaffer, Thomas Wiemann.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
